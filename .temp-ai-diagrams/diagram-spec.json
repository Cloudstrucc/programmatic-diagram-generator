{
  "name": "azure_cmk_key_vault",
  "title": "Azure Customer Managed Keys with Key Vault",
  "description": "Architecture showing Azure services using customer managed keys (CMK) stored in Azure Key Vault for encryption at rest",
  "puml": "@startuml\n!define AzurePuml https://raw.githubusercontent.com/plantuml-stdlib/Azure-PlantUML/release/2-2/dist\n!includeurl AzurePuml/AzureCommon.puml\n!includeurl AzurePuml/Security/AzureKeyVault.puml\n!includeurl AzurePuml/Identity/AzureActiveDirectory.puml\n!includeurl AzurePuml/Identity/AzureManagedIdentity.puml\n!includeurl AzurePuml/Storage/AzureBlobStorage.puml\n!includeurl AzurePuml/Databases/AzureSqlDatabase.puml\n!includeurl AzurePuml/Compute/AzureFunction.puml\n\ntitle Azure Customer Managed Keys with Key Vault\n\nAzureActiveDirectory(aad, \"Azure AD\", \"Identity Provider\")\nAzureKeyVault(kv, \"Key Vault\", \"HSM-backed CMK Storage\")\n\nrectangle \"Data Services\" {\n  AzureBlobStorage(storage, \"Blob Storage\", \"Encrypted Storage\")\n  AzureSqlDatabase(sqldb, \"SQL Database\", \"Encrypted Database\")\n  AzureFunction(func, \"Function App\", \"Encrypted Compute\")\n}\n\nAzureManagedIdentity(mi1, \"Storage MI\", \"System Assigned\")\nAzureManagedIdentity(mi2, \"SQL MI\", \"System Assigned\")\nAzureManagedIdentity(mi3, \"Function MI\", \"System Assigned\")\n\naad -[#800080,dashed]-> kv : RBAC Assignment\nmi1 -[#800080,dashed]-> kv : Authenticate\nmi2 -[#800080,dashed]-> kv : Authenticate\nmi3 -[#800080,dashed]-> kv : Authenticate\n\nstorage -[#FF0000]-> kv : Wrap/Unwrap DEK\nsqldb -[#FF0000]-> kv : TDE Key Operations\nfunc -[#FF0000]-> kv : Encryption Operations\n\nnote right of kv\n  Stores Customer Managed Keys (CMK)\n  - Key rotation policies\n  - HSM protection\n  - Audit logging\nend note\n\nnote bottom of storage : Data encrypted at rest\\\nwith CMK from Key Vault\n\n@enduml",
  "style": "azure"
}