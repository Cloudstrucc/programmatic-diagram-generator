<section style="background: var(--light-bg); padding: 60px 0 80px;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-5">
                    <h1>Generate AI Diagram</h1>
                    <p class="text-muted">Describe your architecture and let AI create it</p>
                    <div class="mt-3">
                        <span class="badge bg-success">{{remaining}} diagrams remaining today</span>
                        <span class="badge bg-secondary">{{user.tier}} tier</span>
                    </div>
                </div>

                {{#unless canCreate}}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    You've reached your daily limit of {{limit}} diagrams. 
                    <a href="/pricing" class="alert-link">Upgrade your plan</a> for more diagrams.
                </div>
                {{/unless}}

                <div class="card shadow" style="border: 2px solid #f0f0f0; border-radius: 15px;">
                    <div class="card-body p-5">
                        <form id="generator-form">
                            <!-- Hidden field for database compatibility -->
                            <input type="hidden" id="diagramType" name="diagramType" value="python">
                            
                            <div class="mb-4">
                                <label for="title" class="form-label fw-bold">Diagram Title</label>
                                <input 
                                    type="text" 
                                    class="form-control form-control-lg" 
                                    id="title" 
                                    name="title" 
                                    placeholder="e.g., Azure AKS Production Setup"
                                    required
                                    {{#unless canCreate}}disabled{{/unless}}
                                >
                            </div>

                            <div class="mb-4">
                                <label for="prompt" class="form-label fw-bold">Description</label>
                                <textarea 
                                    class="form-control" 
                                    id="prompt" 
                                    name="prompt" 
                                    rows="4" 
                                    placeholder="Describe your diagram... e.g., 'Azure AKS cluster with load balancer' or 'User login process with validation steps'"
                                    required
                                    {{#unless canCreate}}disabled{{/unless}}
                                ></textarea>
                                <small class="text-muted">Be specific for better results</small>
                            </div>

                            <!-- Format Selection -->
                            <div class="mb-4">
                                <label for="diagramFormat" class="form-label fw-bold">
                                    <i class="bi bi-diagram-3 me-2"></i>Diagram Format
                                </label>
                                <select class="form-select form-select-lg" id="diagramFormat" name="diagramFormat" {{#unless canCreate}}disabled{{/unless}}>
                                    <option value="graphviz">Cloud Architecture (Icons & Logos)</option>
                                    <option value="graphviz-dot">Traditional Diagrams (Flowcharts/States)</option>
                                </select>
                                <small class="text-muted d-block mt-2" id="format-help">
                                    Best for cloud infrastructure diagrams with proper icons
                                </small>
                            </div>

                            <!-- Style Selection -->
                            <div class="mb-4">
                                <label for="style" class="form-label fw-bold">
                                    <i class="bi bi-palette me-2"></i>Style
                                </label>
                                <select class="form-select form-select-lg" id="style" name="style" {{#unless canCreate}}disabled{{/unless}}>
                                    <optgroup label="Major Cloud Providers">
                                        <option value="azure">Azure</option>
                                        <option value="aws">AWS</option>
                                        <option value="gcp">GCP</option>
                                    </optgroup>
                                    <optgroup label="Modern SaaS & Services">
                                        <option value="saas">SaaS Services (Slack, Auth0, Datadog, Snowflake)</option>
                                        <option value="elastic">Elastic Stack (ELK, Kibana)</option>
                                        <option value="firebase">Firebase (Mobile/Web Apps)</option>
                                    </optgroup>
                                    <optgroup label="Enterprise Cloud">
                                        <option value="ibm">IBM Cloud</option>
                                        <option value="oracle">Oracle Cloud (OCI)</option>
                                    </optgroup>
                                    <optgroup label="Other Platforms">
                                        <option value="k8s">Kubernetes</option>
                                        <option value="digitalocean">Digital Ocean</option>
                                        <option value="alibabacloud">Alibaba Cloud</option>
                                        <option value="generic">Generic / On-Premise</option>
                                    </optgroup>
                                </select>
                                <small class="text-muted d-block mt-2" id="style-help">
                                    Choose your cloud provider or platform
                                </small>
                            </div>

                            <!-- NEW: Draw.io Native Format Checkbox -->
                            <div class="mb-4">
                                <div class="card" style="border: 2px solid #e3f2fd; background-color: #f8f9fa; border-radius: 10px;">
                                    <div class="card-body p-3">
                                        <div class="form-check">
                                            <input 
                                                class="form-check-input" 
                                                type="checkbox" 
                                                id="drawioNative" 
                                                name="drawioNative"
                                                {{#unless canCreate}}disabled{{/unless}}
                                            >
                                            <label class="form-check-label fw-bold" for="drawioNative">
                                                <i class="bi bi-diagram-3-fill me-2 text-primary"></i>
                                                Generate Draw.io Native Format
                                            </label>
                                        </div>
                                        <small class="text-muted d-block mt-2" id="drawio-help">
                                            <strong>When checked:</strong> Creates fully editable Draw.io XML with shapes you can click, move, and edit text in Draw.io<br>
                                            <strong>When unchecked:</strong> Creates beautiful diagrams with provider icons (PNG/SVG export only)
                                        </small>
                                        <div class="alert alert-info mt-2 mb-0" style="padding: 8px 12px; font-size: 0.9em;" id="drawio-info">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <strong>Draw.io Native:</strong> Uses Draw.io's built-in shapes and icon libraries. Text and shapes are fully editable. Best for diagrams you'll modify later.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="quality" class="form-label fw-bold">
                                    <i class="bi bi-sliders me-2"></i>Complexity Level
                                </label>
                                <select class="form-select form-select-lg" id="quality" name="quality" {{#unless canCreate}}disabled{{/unless}}>
                                    <option value="simple">Simple (5-8 components)</option>
                                    <option value="standard" selected>Standard (8-15 components)</option>
                                    <option value="enterprise">Enterprise (15+ components)</option>
                                </select>
                            </div>

                            <!-- Examples Section -->
                            <div class="mb-4">
                                <div class="accordion" id="examplesAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#examplesCollapse">
                                                <i class="bi bi-lightbulb me-2"></i>Example Prompts
                                            </button>
                                        </h2>
                                        <div id="examplesCollapse" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
                                            <div class="accordion-body">
                                                <div id="cloud-examples">
                                                    <h6 class="fw-bold">Cloud Architecture Examples:</h6>
                                                    <ul class="small">
                                                        <li><code>Azure AKS cluster with load balancer, KeyVault, and SQL Database</code></li>
                                                        <li><code>AWS 3-tier web app with ELB, EC2, and RDS</code></li>
                                                        <li><code>GCP microservices with Cloud Run and Cloud SQL</code></li>
                                                        <li><code>Kubernetes deployment with ingress and persistent storage</code></li>
                                                    </ul>
                                                </div>
                                                <div id="traditional-examples" style="display: none;">
                                                    <h6 class="fw-bold">Flowchart Examples:</h6>
                                                    <ul class="small">
                                                        <li><code>User login process with email verification and 2FA</code></li>
                                                        <li><code>Order processing workflow from cart to delivery</code></li>
                                                        <li><code>CI/CD pipeline from commit to production deployment</code></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" style="background: var(--secondary-color); border: none;" {{#unless canCreate}}disabled{{/unless}}>
                                    <i class="bi bi-magic me-2"></i>Generate Diagram
                                </button>
                            </div>
                        </form>

                        <div id="status-area" class="mt-4" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                                    <div>
                                        <strong>Generating your diagram...</strong>
                                        <p class="mb-0 small" id="status-text">Please wait...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Dynamic format/style switching
document.addEventListener('DOMContentLoaded', function() {
    const formatSelect = document.getElementById('diagramFormat');
    const styleSelect = document.getElementById('style');
    const formatHelp = document.getElementById('format-help');
    const styleHelp = document.getElementById('style-help');
    const cloudExamples = document.getElementById('cloud-examples');
    const traditionalExamples = document.getElementById('traditional-examples');
    const drawioCheckbox = document.getElementById('drawioNative');
    const drawioHelp = document.getElementById('drawio-help');
    const drawioInfo = document.getElementById('drawio-info');

    // Style options for each format
    const styleOptions = {
        'graphviz': {
            styles: [
                { value: 'azure', label: 'Azure', group: 'Major Cloud' },
                { value: 'aws', label: 'AWS', group: 'Major Cloud' },
                { value: 'gcp', label: 'GCP', group: 'Major Cloud' },
                { value: 'saas', label: 'SaaS Services', group: 'SaaS' },
                { value: 'elastic', label: 'Elastic Stack', group: 'SaaS' },
                { value: 'firebase', label: 'Firebase', group: 'SaaS' },
                { value: 'ibm', label: 'IBM Cloud', group: 'Enterprise' },
                { value: 'oracle', label: 'Oracle Cloud', group: 'Enterprise' },
                { value: 'k8s', label: 'Kubernetes', group: 'Other' },
                { value: 'digitalocean', label: 'Digital Ocean', group: 'Other' },
                { value: 'alibabacloud', label: 'Alibaba Cloud', group: 'Other' },
                { value: 'generic', label: 'Generic', group: 'Other' }
            ],
            formatHelp: 'Best for cloud infrastructure with proper icons and logos',
            styleHelp: 'Choose your cloud provider or platform'
        },
        'graphviz-dot': {
            styles: [
                { value: 'flowchart', label: 'Flowchart / Process Diagram' },
                { value: 'state', label: 'State Machine' },
                { value: 'orgchart', label: 'Organization Chart' },
                { value: 'network', label: 'Network Topology' },
                { value: 'sequence', label: 'Sequence Diagram' }
            ],
            formatHelp: 'Best for process flows, state machines, org charts',
            styleHelp: 'Choose your diagram type'
        }
    };

    function updateDrawioInfo() {
        const isChecked = drawioCheckbox.checked;
        const format = formatSelect.value;
        
        if (isChecked) {
            drawioInfo.innerHTML = '<i class="bi bi-check-circle-fill text-success me-1"></i>' +
                '<strong>Draw.io Native Mode:</strong> Generates editable XML with shapes, text, and icons from Draw.io libraries. ' +
                'Open directly in Draw.io to edit everything.';
            drawioInfo.className = 'alert alert-success mt-2 mb-0';
        } else {
            drawioInfo.innerHTML = '<i class="bi bi-info-circle me-1"></i>' +
                '<strong>Standard Mode:</strong> Generates beautiful diagrams with authentic provider icons. ' +
                'Export as PNG or SVG (shapes editable after ungrouping in Draw.io).';
            drawioInfo.className = 'alert alert-info mt-2 mb-0';
        }
        drawioInfo.style.padding = '8px 12px';
        drawioInfo.style.fontSize = '0.9em';
    }

    formatSelect.addEventListener('change', function() {
        const format = this.value;
        const config = styleOptions[format];

        // Update style dropdown
        styleSelect.innerHTML = '';
        
        if (format === 'graphviz') {
            const groups = { 'Major Cloud': [], 'SaaS': [], 'Enterprise': [], 'Other': [] };
            config.styles.forEach(style => groups[style.group].push(style));
            
            Object.keys(groups).forEach(groupName => {
                if (groups[groupName].length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = groupName;
                    groups[groupName].forEach(style => {
                        const option = document.createElement('option');
                        option.value = style.value;
                        option.textContent = style.label;
                        optgroup.appendChild(option);
                    });
                    styleSelect.appendChild(optgroup);
                }
            });
        } else {
            config.styles.forEach(style => {
                const option = document.createElement('option');
                option.value = style.value;
                option.textContent = style.label;
                styleSelect.appendChild(option);
            });
        }

        formatHelp.textContent = config.formatHelp;
        styleHelp.textContent = config.styleHelp;

        if (format === 'graphviz') {
            cloudExamples.style.display = 'block';
            traditionalExamples.style.display = 'none';
        } else {
            cloudExamples.style.display = 'none';
            traditionalExamples.style.display = 'block';
        }
    });

    drawioCheckbox.addEventListener('change', updateDrawioInfo);
    updateDrawioInfo();
});
</script>

<script src="/js/diagram-generator.js"></script>
